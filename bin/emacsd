#!/usr/bin/ruby
DEATH_WAIT = 3
log_fp = File.expand_path('~/Library/Logs/emacsd.log')

begin
  open(log_fp, "a") do |iost|
    iost.puts "#{Time.now} Starting up emacs daemon"
  end
  `/usr/local/bin/emacs --daemon`

  while true
    sleep 86300
  end

rescue Exception => all_exception
  `/usr/local/bin/emacsclient --eval "(progn (setq kill-emacs-hook 'nil) (kill-emacs))"`

  open(log_fp, "a") do |iost|
    iost.puts "#{Time.now} Tearing down emacs daemon; received signal #{all_exception}"

    iost.print "#{Time.now} Waiting #{DEATH_WAIT} seconds for emacs daemon to die... "
    iost.flush
    sleep DEATH_WAIT
    iost.puts "done."
  end

end
